version: 2.1

jobs:
  build:
    docker:
      - image: cimg/python:3.11
    steps:
      - checkout
      - run:
          name: "Install UV"
          command: |
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV
            uv --version
      - run:
          name: "Create Venv & Install Dependencies"
          command: |
            uv venv --python 3.11
            source .venv/bin/activate
            uv sync --all-packages --group dev --verbose
      - run:
          name: "Verify Installation"
          command: |
            source .venv/bin/activate
            ruff --version
            pytest --version
            mypy --version
      - persist_to_workspace:
          root: .
          paths:
            - .

  lint:
    docker:
      - image: cimg/python:3.11
    steps:
      - attach_workspace:
          at: .
      - run:
          name: "Ruff Check"
          command: |
            source .venv/bin/activate
            ruff check .
      - run:
          name: "Ruff Format Check"
          command: |
            source .venv/bin/activate
            ruff format --check .

  typecheck:
    docker:
      - image: cimg/python:3.11
    steps:
      - attach_workspace:
          at: .
      - run:
          name: "Mypy Strict"
          command: |
            source .venv/bin/activate
            mypy components/

  unit_test:
    docker:
      - image: cimg/python:3.11
    steps:
      - attach_workspace:
          at: .
      - run:
          name: "Run Unit Tests"
          command: |
            source .venv/bin/activate
            mkdir -p test-results/unit
            pytest components/ \
              --cov=components/ \
              --cov-report=xml \
              --cov-report=html:coverage-html \
              --cov-report=term \
              --junitxml=test-results/unit/junit.xml \
              --cov-fail-under=85
      - store_test_results:
          path: test-results/unit
      - store_artifacts:
          path: coverage.xml
      - store_artifacts:
          path: coverage-html
          destination: coverage
      - store_artifacts:
          path: test-results/unit

  integration_test:
    docker:
      - image: cimg/python:3.11
    steps:
      - attach_workspace:
          at: .
      - run:
          name: "Run Integration Tests"
          command: |
            source .venv/bin/activate
            mkdir -p test-results/integration
            pytest tests/integration/ \
              --junitxml=test-results/integration/junit.xml \
              -v \
              --no-cov
      - store_test_results:
          path: test-results/integration
      - store_artifacts:
          path: test-results/integration

  e2e_test:
    docker:
      - image: cimg/python:3.11
    environment:
      GCS_BUCKET_NAME: ${GCS_BUCKET_NAME}
      GOOGLE_CLOUD_PROJECT: ${GOOGLE_CLOUD_PROJECT}
      GCP_SERVICE_KEY: ${GCP_SERVICE_KEY}
    steps:
      - attach_workspace:
          at: .
      - run:
          name: "Run E2E Tests"
          command: |
            source .venv/bin/activate
            mkdir -p test-results/e2e
            pytest tests/e2e/ \
              --junitxml=test-results/e2e/junit.xml \
              -v \
              --no-cov
      - store_test_results:
          path: test-results/e2e
      - store_artifacts:
          path: test-results/e2e

workflows:
  build_and_test:
    jobs:
      - build:
          filters:
            branches:
              ignore:
                - main
      - lint:
          requires:
            - build
      - typecheck:
          requires:
            - build
      - unit_test:
          requires:
            - build
      - integration_test:
          requires:
            - unit_test
      - e2e_test:
          requires:
            - integration_test
